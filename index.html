<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dungeon Dasher</title>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: monospace;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    h1 { margin: 10px 0; }
    canvas {
      border: 3px solid #eee;
      margin-top: 10px;
      background: #222;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    #shop {
      display: none;
      margin-top: 20px;
      padding: 10px;
      border: 2px solid #eee;
      background: #222;
    }
    button {
      margin: 5px;
      padding: 8px 15px;
      font-family: monospace;
      background: #333;
      color: #eee;
      border: 1px solid #eee;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>Dungeon Dasher</h1>
  <canvas id="gameCanvas" width="400" height="400"></canvas>
  <p id="hud">Coins: 0 | Health: 3</p>

  <div id="shop">
    <h2>üè™ Shop</h2>
    <p id="shop-coins"></p>
    <button id="buy-health">+1 Max Health (Cost: 5)</button>
    <button id="buy-speed">Faster Moves (Cost: 5)</button>
    <button id="next-run">Next Run ‚ñ∂</button>
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const hud = document.getElementById("hud");
    const shopDiv = document.getElementById("shop");
    const shopCoins = document.getElementById("shop-coins");
    const btnHealth = document.getElementById("buy-health");
    const btnSpeed = document.getElementById("buy-speed");
    const btnNext = document.getElementById("next-run");

    const gridSize = 8;
    const cellSize = canvas.width / gridSize;

    // Persistent stats
    let saveData = JSON.parse(localStorage.getItem("dasherSave")) || {
      coins: 0,
      maxHealth: 3,
      speedBoost: 0
    };

    // Run-specific state
    let player, stairs, enemies, coins, health;

    function startRun() {
      player = { x: 0, y: 0 };
      stairs = { x: gridSize - 1, y: gridSize - 1 };
      enemies = [];
      coins = [];
      health = saveData.maxHealth;

      spawnEnemies(3 + Math.floor(Math.random() * 3));
      spawnCoins(3);
      updateHUD();
      shopDiv.style.display = "none";
      canvas.style.display = "block";
    }

    function spawnEnemies(n) {
      enemies = [];
      for (let i = 0; i < n; i++) {
        let ex = Math.floor(Math.random() * gridSize);
        let ey = Math.floor(Math.random() * gridSize);
        if ((ex !== 0 || ey !== 0) && (ex !== stairs.x || ey !== stairs.y)) {
          enemies.push({ x: ex, y: ey });
        }
      }
    }

    function spawnCoins(n) {
      coins = [];
      for (let i = 0; i < n; i++) {
        let cx = Math.floor(Math.random() * gridSize);
        let cy = Math.floor(Math.random() * gridSize);
        if ((cx !== 0 || cy !== 0) && (cx !== stairs.x || cy !== stairs.y)) {
          coins.push({ x: cx, y: cy });
        }
      }
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Grid
      ctx.strokeStyle = "#444";
      for (let i = 0; i < gridSize; i++) {
        for (let j = 0; j < gridSize; j++) {
          ctx.strokeRect(i * cellSize, j * cellSize, cellSize, cellSize);
        }
      }

      // Player
      ctx.fillStyle = "lime";
      ctx.fillRect(player.x * cellSize, player.y * cellSize, cellSize, cellSize);

      // Stairs
      ctx.fillStyle = "gold";
      ctx.fillRect(stairs.x * cellSize, stairs.y * cellSize, cellSize, cellSize);

      // Coins
      ctx.fillStyle = "yellow";
      coins.forEach(c => ctx.fillRect(c.x * cellSize, c.y * cellSize, cellSize, cellSize));

      // Enemies
      ctx.fillStyle = "red";
      enemies.forEach(e => ctx.fillRect(e.x * cellSize, e.y * cellSize, cellSize, cellSize));
    }

    function moveEnemies() {
      enemies.forEach(e => {
        if (Math.abs(player.x - e.x) > Math.abs(player.y - e.y)) {
          e.x += player.x > e.x ? 1 : -1;
        } else {
          e.y += player.y > e.y ? 1 : -1;
        }
      });
    }

    function checkCollisions() {
      // Coin pickup
      coins = coins.filter(c => {
        if (c.x === player.x && c.y === player.y) {
          saveData.coins++;
          updateHUD();
          return false;
        }
        return true;
      });

      // Stairs (win round)
      if (player.x === stairs.x && player.y === stairs.y) {
        openShop();
      }

      // Enemy collision (lose HP)
      enemies.forEach(e => {
        if (e.x === player.x && e.y === player.y) {
          health--;
          if (health <= 0) {
            alert("You died! Game over.");
            saveData.coins = 0; // lose coins on death
            saveGame();
            openShop(true);
          } else {
            updateHUD();
          }
        }
      });
    }

    function handleInput(e) {
      if (shopDiv.style.display === "block") return;

      let moved = false;
      let step = 1 + saveData.speedBoost;

      if (e.key === "ArrowUp" || e.key === "w") { player.y = Math.max(0, player.y - step); moved = true; }
      if (e.key === "ArrowDown" || e.key === "s") { player.y = Math.min(gridSize - 1, player.y + step); moved = true; }
      if (e.key === "ArrowLeft" || e.key === "a") { player.x = Math.max(0, player.x - step); moved = true; }
      if (e.key === "ArrowRight" || e.key === "d") { player.x = Math.min(gridSize - 1, player.x + step); moved = true; }

      if (moved) {
        moveEnemies();
        checkCollisions();
      }
    }

    document.addEventListener("keydown", handleInput);

    function updateHUD() {
      hud.textContent = `Coins: ${saveData.coins} | Health: ${health}/${saveData.maxHealth}`;
    }

    function saveGame() {
      localStorage.setItem("dasherSave", JSON.stringify(saveData));
    }

    function openShop(gameOver = false) {
      canvas.style.display = "none";
      shopDiv.style.display = "block";
      shopCoins.textContent = `You have ${saveData.coins} coins.`;
      btnNext.textContent = gameOver ? "Restart ‚ñ∂" : "Next Run ‚ñ∂";
      btnHealth.disabled = saveData.coins < 5;
      btnSpeed.disabled = saveData.coins < 5;
    }

    btnHealth.onclick = () => {
      if (saveData.coins >= 5) {
        saveData.coins -= 5;
        saveData.maxHealth++;
        saveGame();
        openShop();
      }
    };

    btnSpeed.onclick = () => {
      if (saveData.coins >= 5) {
        saveData.coins -= 5;
        saveData.speedBoost++;
        saveGame();
        openShop();
      }
    };

    btnNext.onclick = () => {
      saveGame();
      startRun();
    };

    function gameLoop() {
      if (shopDiv.style.display === "none") {
        draw();
      }
      requestAnimationFrame(gameLoop);
    }

    startRun();
    gameLoop();
  </script>
</body>
</html>
